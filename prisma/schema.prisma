generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["referentialIntegrity"]
}

datasource db {
  provider             = "mysql"
  url                  = env("DATABASE_URL")
  referentialIntegrity = "prisma"
}

model User {
  id       Int    @id @default(autoincrement())
  crowdId  String
  role     Role   @relation(fields: [roleId], references: [id])
  roleId   Int
  password String

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now()) @updatedAt
  document            Document[]
  microtaskAllocation MicrotaskAllocation[]

  @@map("users")
}

enum RoleKind {
  WRITER
  WORKER
  ADMIN
}

model Role {
  id    Int      @id @default(autoincrement())
  kind  RoleKind @unique
  users User[]

  @@map("roles")
}

model Document {
  id        Int         @id @default(autoincrement())
  title     String
  // should be lexical replesantation
  body      String
  author    User        @relation(fields: [authorId], references: [id])
  authorId  Int
  paragrahs Paragraph[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("documents")
}

enum SentenceKind {
  OPINION
  FACT
  NONE
}

// タスクで表示するのはパラグラフごとだが，センテンスに対する結果が必要
model Sentence {
  id   Int          @id @default(autoincrement())
  body String
  kind SentenceKind @default(NONE)

  paragraph       Paragraph         @relation(fields: [paragraphId], references: [id])
  paragraphId     Int
  microtaskResult MicrotaskResult[]

  @@map("sentences")
}

model Paragraph {
  id         Int         @id @default(autoincrement())
  body       String
  document   Document    @relation(fields: [documentId], references: [id])
  documentId Int
  microtasks Microtask[]
  sentences  Sentence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("paragrahs")
}

enum MicrotaskKinds {
  DISTINGUISH_OPINION_AND_FACT
  CHECK_FACT_RESOURCE
  CHECK_IF_OPINION_HAS_VALID_FACT
  REVIEW_OTHER_WORKERS_RESULT
}

// センテンスとパラグラフを一意に特定できるモデル
model Microtask {
  id          Int            @id @default(autoincrement())
  title       String
  body        String
  kind        MicrotaskKinds
  paragraph   Paragraph      @relation(fields: [paragraphId], references: [id])
  paragraphId Int

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now()) @updatedAt
  microtaskAllocation MicrotaskAllocation[]

  @@map("microtasks")
}

model MicrotaskResult {
  id     Int     @id @default(autoincrement())
  // MTask1: OPINION or FACT, MTask2/3: TRUE or FALSE (as string)
  value  String
  // MTask1 : NULL, MTask2/3: the reason
  reason String?

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now()) @updatedAt
  microtaskAllocation MicrotaskAllocation[]
  sentence            Sentence              @relation(fields: [sentenceId], references: [id])
  sentenceId          Int

  @@map("microtask_results")
}


model MicrotaskAllocation {
  id                Int             @id @default(autoincrement())
  user              User            @relation(fields: [userId], references: [id])
  userId            Int
  microtask         Microtask       @relation(fields: [microtaskId], references: [id])
  microtaskId       Int
  microtaskResult   MicrotaskResult @relation(fields: [microtaskResultId], references: [id])
  microtaskResultId Int
  startedAt         DateTime        @default(now())
  completedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @default(now()) @updatedAt

  @@map("microtask_alocations")
}
